graph LR
  subgraph Kafka ["Kafka"]
    direction TB
      subgraph Topics ["Topics"]
        direction LR
          RR[(review_raw)]
          RD[(review_dlq)]
          IT[(inference)]
          GT[(gold-topic)]
      end
      KC[Kafka Connect: Iceberg Source Connector]
  end
  subgraph FastAPI ["FastAPI"]
    API[FastAPI Endpoint]
    SER[Avro Serializer]
    COND{{Schema Valid?}}
    ERR[Error Handler]
  end
  subgraph SparkJobs ["Spark Jobs"]
    direction LR
      D[Spark Job: Preprocessing]
      RP[Spark Job: Reprocessing<br>RocksDB & Schema Validation]
      GSJ[Spark Job: Aggregation]
  end
  subgraph InferenceContainer ["Inference Container"]
    ML[Inference Container: Hugging Face Transformers]
  end
  subgraph IcebergTables ["Iceberg Tables"]
    direction LR
      BR[(bronze)]
      E[(silver)]
      F[(gold)]
  end
  A((Start)) -->|POST:Review_Data| PL[/Payload/]
  PL -->|Receive:Payload| API
  API -->|GET:Schema| SR[Confluent Schema Registry]
  API -->|Serialize:Payload| SER
  SR -->|Provide:Schema| AVRO1[/Schema/]
  AVRO1 -->|Use:Schema| SER
  AVRO1 -->|Use:Schema| RP
  SER -->|Validate:Serialized_Msg| COND
  COND -->|Yes:Valid_Avro_Msg| AVRO3[/Avro Message/]
  COND -->|No:Error| ERR
  ERR -->|Generate:Error_Avro_Msg| AVRO2[/Avro Error Message/]
  AVRO2 -->|Publish:Error_Msg| RD
  RD -->|Consume:Error_Msg| RP
  RP -->|Validate_Retry:Valid_Msg| RR
  AVRO3 -->|Publish:Valid_Msg| RR
  RR -->|Consume:Raw_Msg| D
  D -->|Output:Processed_JSON| JSON[/Processed JSON for Inference/]
  D -->|Store:Bronze_Data| BR
  D -->|Upsert:Processed_Data| E
  JSON -->|Publish:Inference_Msg| IT
  IT -->|Consume:Inference_Msg| ML
  ML -->|Upsert:Analyzed_Data| E
  E -->|CDC_Publish:Events| KC
  KC -->|Publish:CDC_Events| GT
  GT -->|Consume:CDC_Events| GSJ
  GSJ -->|Store:Aggregated_Data| F
  F -->|Query:Aggregated_Data| G[Superset Dashboard: Complaint Trends]
  style A fill:#d9d9d9,stroke:#FFFFFF,stroke-width:1px,color:#000000
  style SR fill:#00A7B5,stroke:#FFFFFF,stroke-width:1px,color:#000000
  style AVRO1 fill:#f0f0f0,stroke:#FFFFFF,stroke-width:1px,color:#000000
  style COND fill:#009688,stroke:#FFFFFF,stroke-width:1px,color:#000000
  style RR fill:#000000,stroke:#FFFFFF,stroke-width:1px,color:#FFFFFF
  style RD fill:#000000,stroke:#FFFFFF,stroke-width:1px,color:#FFFFFF
  style AVRO2 fill:#f0f0f0,stroke:#FFFFFF,stroke-width:1px,color:#000000
  style AVRO3 fill:#f0f0f0,stroke:#FFFFFF,stroke-width:1px,color:#000000
  style PL fill:#f0f0f0,stroke:#FFFFFF,stroke-width:1px,color:#000000
  style API fill:#009688,stroke:#FFFFFF,stroke-width:1px,color:#000000
  style SER fill:#009688,stroke:#FFFFFF,stroke-width:1px,color:#000000
  style ERR fill:#009688,stroke:#FFFFFF,stroke-width:1px,color:#000000
  style D fill:#E25A1C,stroke:#FFFFFF,stroke-width:1px,color:#000000
  style JSON fill:#f0f0f0,stroke:#FFFFFF,stroke-width:1px,color:#000000
  style IT fill:#000000,stroke:#FFFFFF,stroke-width:1px,color:#FFFFFF
  style BR fill:#CD7F32,stroke:#FFFFFF,stroke-width:1px,color:#000000
  style E fill:#C0C0C0,stroke:#FFFFFF,stroke-width:1px,color:#000000
  style F fill:#FFD700,stroke:#FFFFFF,stroke-width:1px,color:#000000
  style G fill:#6B46C1,stroke:#FFFFFF,stroke-width:1px,color:#000000
  style Kafka fill:#f0f0f0,stroke:#333333,stroke-width:2px
  style SparkJobs fill:#ffecd6,stroke:#E25A1C,stroke-width:2px
  style InferenceContainer fill:#E6F7FA,stroke:#0DB7ED,stroke-width:2px
  style IcebergTables fill:#e6f3ff,stroke:#4A90E2,stroke-width:2px
  style Topics fill:#ffffff,stroke:#333333,stroke-width:1px
  style RP fill:#E25A1C,stroke:#FFFFFF,stroke-width:1px,color:#000000
  style ML fill:#0DB7ED,stroke:#FFFFFF,stroke-width:1px,color:#000000
  style GSJ fill:#E25A1C,stroke:#FFFFFF,stroke-width:1px,color:#000000
  style FastAPI fill:#B2DFDB,stroke:#009688,stroke-width:2px
  style KC fill:#000000,stroke:#FFFFFF,stroke-width:1px,color:#FFFFFF
  style GT fill:#000000,stroke:#FFFFFF,stroke-width:1px,color:#FFFFFF