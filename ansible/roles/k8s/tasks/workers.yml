---
- name: Join Kubernetes worker node safely
  vars:
    # 마스터 노드에서 전달된 kubeadm join 명령어를 변수로 설정
    kubeadm_join_cmd: "{{ hostvars[groups['control_plane_node'][0]]['kubeadm_join_cmd'] }}"

  block:
    # 워커 노드에 kubelet.conf 파일이 존재하는지, 그리고 크기가 0인지 확인
    - name: Check if kubelet.conf exists
      stat:
        path: /etc/kubernetes/kubelet.conf
      register: kubeconf_stat

    # 파일이 존재하고 0바이트 이상이면 내용을 base64로 읽음 (slurp는 바이너리도 지원)
    - name: Slurp kubelet.conf if it exists and has content
      slurp:
        src: /etc/kubernetes/kubelet.conf
      register: kubeconf_data
      when: kubeconf_stat.stat.exists and kubeconf_stat.stat.size > 0

    # base64 디코딩하여 텍스트로 저장 → 이후에 apiVersion 키가 포함되어 있는지 검사할 수 있음
    - name: Decode kubelet.conf content
      set_fact:
        kubeconf_text: "{{ kubeconf_data.content | b64decode }}"
      when: kubeconf_data is defined and 'content' in kubeconf_data

    # kubelet.conf가 없거나, 비어 있거나, 유효하지 않은 경우 kubeadm reset 실행 (클러스터 상태 초기화)
    - name: Reset node if kubelet.conf is missing or invalid
      become: true
      command: kubeadm reset -f
      when: >
        (not kubeconf_stat.stat.exists) or
        (kubeconf_stat.stat.exists and (
          kubeconf_stat.stat.size == 0 or
          kubeconf_text is not defined or
          kubeconf_text is not search('apiVersion')
        ))

    # reset 후 관련 디렉토리 및 남은 설정을 깨끗하게 삭제
    - name: Remove leftover Kubernetes files
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - /etc/kubernetes
        - /var/lib/kubelet
        - /etc/cni/net.d
        - /var/lib/cni
      when: >
        (not kubeconf_stat.stat.exists) or
        (kubeconf_stat.stat.exists and (
          kubeconf_stat.stat.size == 0 or
          kubeconf_text is not defined or
          kubeconf_text is not search('apiVersion')
        ))

    # CNI 플러그인을 다시 쓰기 위해 containerd도 재시작
    - name: Restart containerd
      systemd:
        name: containerd
        state: restarted
      when: >
        (not kubeconf_stat.stat.exists) or
        (kubeconf_stat.stat.exists and (
          kubeconf_stat.stat.size == 0 or
          kubeconf_text is not defined or
          kubeconf_text is not search('apiVersion')
        ))

    # kubeadm join 명령어 실행 → 노드를 클러스터에 조인시킴 (필요할 때만 실행됨)
    - name: Run kubeadm join (if needed)
      command: "{{ kubeadm_join_cmd }}"
      when: >
        (not kubeconf_stat.stat.exists) or
        (kubeconf_stat.stat.exists and (
          kubeconf_stat.stat.size == 0 or
          kubeconf_text is not defined or
          kubeconf_text is not search('apiVersion')
        ))

    # 태스크 완료 여부를 사용자에게 출력
    - name: Confirm node join attempt
      debug:
        msg: "Join attempted (or skipped if already valid) on {{ inventory_hostname }}."