---
- name: Verification file actions
  ansible.builtin.shell: >-
    {% if item.dest | regex_search('KEYS$') %}
    gpg --import "{{ item.dest }}" || echo "Failed to import keys from {{ item.dest }}"
    {% elif item.dest | regex_search('.asc$') %}
    gpg --verify "{{ item.dest }}" "{{ framework_file.dest }}" || echo "Failed to verify signature {{ item.dest }}"
    {% elif item.dest | regex_search('.sha512$') %}
    sha512sum -c "{{ item.dest }}" || echo "Failed to verify SHA512 checksum {{ item.dest }}"
    {% else %}
    echo "Unknown verification file type: {{ item.dest }}"
    exit 1
    {% endif %}
  args:
    chdir: "{{ download_path.path }}"
    executable: /bin/bash
  loop: "{{ verification_files.results }}"
  loop_control:
    label: "{{ item.dest }}"
  register: verify_results
  when: item.dest is defined
  ignore_errors: true

- name: Show verification summary
  ansible.builtin.debug:
    msg: >-
      {{
        "✔ GPG verified: " ~ item.item.dest if (item.rc == 0 and 'gpg --verify' in item.cmd)
        else
        "✔ SHA512 valid: " ~ item.item.dest if (item.rc == 0 and 'sha512sum' in item.cmd)
        else
        "✔ KEYS imported: " ~ item.item.dest if (item.rc == 0 and 'gpg --import' in item.cmd)
        else
        "❌ Verification failed: " ~ item.item.dest ~ " (Exit code: " ~ item.rc ~ ")"
      }}
  loop: "{{ verify_results.results }}"
  loop_control:
    label: "{{ item.item.dest }}"
  when: item.rc is defined

- name: Identify failed verification tasks
  ansible.builtin.set_fact:
    failed_verifications: "{{ verify_results.results | selectattr('rc', 'ne', 0) | map(attribute='item.dest') | list }}"

- name: Exit if any verification step failed
  ansible.builtin.fail:
    msg: >-
      Verification failed for: {{ failed_verifications | join(', ') }}
  when: failed_verifications | length > 0